#!/bin/bash

# Lockpick Module: Exploit Suggester

TARGET="$1"
LOG_DIR="$HOME/Nexus/logs/lockpick"
SCANFILE="$LOG_DIR/lockpick_scan_${TARGET}.txt"
LOGFILE="$LOG_DIR/lockpick_exploits_${TARGET}.log"
GHOST_FLAG="$HOME/Nexus/coreops/.ghost/ghost_enabled"

mkdir -p "$LOG_DIR"

if [[ -z "$TARGET" ]]; then
    echo "Usage: $0 <target IP or domain>"
    exit 1
fi

if [[ ! -f "$SCANFILE" ]]; then
    echo "Error: No scan file found for $TARGET. Run scan.sh first."
    exit 1
fi

if ! command -v searchsploit &> /dev/null; then
    echo "[-] searchsploit not found. Please install ExploitDB tools."
    exit 1
fi

# Ghost Mode Detection
if [[ -f "$GHOST_FLAG" ]]; then
    echo "[⚠] GHOST MODE ACTIVE — results may be incomplete."
    echo "[⚠] Ghost mode active during exploit suggest." >> "$LOGFILE"
fi

echo "Lockpick Exploit Suggestions - $TARGET" | tee "$LOGFILE"
echo "---" >> "$LOGFILE"
echo "[+] Date: $(date)" >> "$LOGFILE"

# Parse services and use searchsploit
grep -E "^[0-9]+/tcp.*open" "$SCANFILE" | while read -r line; do
    echo "[+] Searching exploits for: $line" | tee -a "$LOGFILE"
    SERVICE=$(echo "$line" | cut -d ' ' -f 3- | sed 's/ [0-9]*\/tcp.*//g')
    if [[ -n "$SERVICE" ]]; then
        echo "Service: $SERVICE" >> "$LOGFILE"
        searchsploit "$SERVICE" >> "$LOGFILE"
        echo "---" >> "$LOGFILE"
    fi
done

"$HOME/Nexus/coreops/mcl/encrypt_log.sh" "$LOGFILE"

